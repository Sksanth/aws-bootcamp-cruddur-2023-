# Week 10-11 â€” CloudFormation Part 1 and Part 2

## Summary:
Convert ClickOps infrastructure to CloudFormation and SAM templates

### Update 
```gitpod.yml``` file 
```
- name: cfn
  before: |
    pip install cfn-lint
    cargo install cfn-guard
```
```
export CFN_BUCKET="your-cfn-artifacts"
gp env CFN_BUCKET="your-cfn-artifacts"
```
## CFN for Network Layer

Inside the ```aws``` dir, create ```cfn``` then ```networking``` folder into it and  create files [template.yaml](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/aws/cfn/networking/template.yaml) and [config.toml](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/aws/cfn/networking/config.toml)


Also create a folder called ```cfn``` under the ```bin``` dir and a script [networking](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/bin/cfn/networking)  

Run the commands to create a CFN stack
```
chmod bin/cfn/networking
 ./bin/cfn/networking
```
```
pip install cfn-lint
cfn-lint /workspace/aws-bootcamp-cruddur-2023-/aws/cfn/networking/template.yaml
cargo install cfn-guard
```

![CrdNet in progress](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/assets/102387885/fc94061f-9136-4d0a-b47c-448706704e88)
![CrdNet craeted1](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/assets/102387885/a1626d82-247c-40df-90d0-f59e0e71b0ab)

## CFN for Cluster Layer

Install **cfn-toml**<br>
```gem install cfn-toml``` 
and update the ``` gitpod.yml``` file

Inside the ```aws/cfn``` dir, create a new folder ```cluster``` and files [template.yaml](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/aws/cfn/cluster/template.yaml) and [config.toml](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/aws/cfn/cluster/config.toml)

Create a new script [cluster](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/bin/cfn/cluster) under ```bin/cfn``` dir

Run
```
chmod u+x bin/cfn/cluster
./bin/cfn/cluster
```

![cmds to crdNet and crdCluster](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/assets/102387885/75c139c7-0bb6-4416-8215-ae737f18cc6a)

![CrdCluster-success](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/assets/102387885/a5a77449-8426-4201-8010-2265b8e7c98c)

## CFN for RDS

In the ```aws/cfn/``` create a new folder ```db``` and files [template.yaml](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/aws/cfn/db/template.yaml) and [config.toml](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/aws/cfn/db/config.toml)

```
export DB_PASSWORD="password"
gp env DB_PASSWORD="password"
```

Create a new script [db](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/bin/cfn/db) under ```bin/cfn``` dir

```
chmod u+x bin/cfn/db
./bin/cfn/db
```
![CrdDb success](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/assets/102387885/4b6dd917-9354-43bc-bf56-b6c9c90411c7)


**Update AWS System mangers's parameter store CONNECTION_URL value**



## CFN for Fargate Service Layer
Update the ``` bin/backend/connect``` , ``` bin/backend/deploy``` with the new cluster name ```CrdClusterFargateCluster```<br>
Create a script [create-service](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/bin/backend/create-service) inside ```bin/backend``` dir
```
chmod bin/backend/create-service
./bin/backend/create-service
```
update ```aws/json/service-backend-flask.json``` with the **cluster name**, **Target Group arn of the backend flask** and **public subnet ids** (copy from CrdNet stack) then in the console edit the **inbound rules** of ```crud-srv-sg``` and run ```./bin/backend/deploy```

change the ```backend TG``` health check port to ```4567``` from the default value ```80```

![backend TG health check port](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/assets/102387885/921bf29c-ec32-491d-9f75-c85be2c10084)


In the ```aws/cfn/``` create a new folder ```service``` and files [template.yaml](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/aws/cfn/service/template.yaml) and [config.toml](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/aws/cfn/service/config.toml)

Create a new script [service](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/bin/cfn/service)
under ```bin/cfn``` dir

```
chmod u+x bin/cfn/service
./bin/cfn/service
```

![CrdSrvBackendFlask - success](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/assets/102387885/3a16eac7-3514-4ac6-aece-46719c377100)

Update the ```Route 53``` record with new alb ```CrdClusterALB``` and do the ```api/health-check``` 


![skscorp api health check - true](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/assets/102387885/6907bedb-4533-433f-8a5a-bc8d361821bd)

## SAM CFN for DynamoDB
Create a new folder ```ddb``` in the root level 
And ```function``` into it then create file [lambda_function.py](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/ddb/function/lambda_function.py)

Create files [template.yaml](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/ddb/template.yaml), [config.toml](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/ddb/config.toml)

And scripts [build](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/ddb/build), [package](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/ddb/package), [deploy](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/ddb/deploy) 

```
 chmod u+x ddb/[script_name]
 ./ddb/[script_name]
```
![ddb build](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/assets/102387885/08a9153e-9d98-4f5e-b582-05b0a282bcfd)

![ddb package](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/assets/102387885/66bfb22e-8f0a-4357-bde6-8764c81d769d)

![ddb-deploy cmd](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/assets/102387885/c4f1e5bd-d264-48cf-b405-c7bf471ef1fb)

![CrdDdb success](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/assets/102387885/b8c324be-b89e-41d4-9334-906f47e0b7f7)

## CFN for CI/CD

Create "your_domain_name-codepipeline-cruddur-artifacts" bucket

Create a new folder ```cicd``` inside ```aws/cfn``` dir and files [template.yaml](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/aws/cfn/cicd/template.yaml), [config.toml](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/aws/cfn/cicd/config.toml)
Then ```nested``` folder and file [codebuild.yaml](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/aws/cfn/cicd/nested/codebuild.yaml)
Create an empty folder in the root called ```tmp``` to store ```packaged-template.yaml``` and add ```tmp/*``` in the gitignore file

![tmp folder packaged-template yaml file](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/assets/102387885/7bd6f4c9-7ec1-4ca8-ad20-2f67a9ffa405)

Create ``` cicd ``` script in ```bin/cfn``` dir
```
chmod u+x bin/cfn/cicd-deploy 
./bin/cfn/cicd-deploy
``` 
![CrdCicd success](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/assets/102387885/27c71efd-361a-472a-bd41-a314c2100f76)

In the console ```Update pending connection``` for the ```CrdCicd``` connection  

![cicd connection done](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/assets/102387885/3833eee5-f05c-4213-b2de-6db5411481d3)


## CFN Static Website Hosting Frontend
Delete the **naked domain name** in Route53

Create a new folder ```frontend``` in ```aws/cfn``` dir and files [template.yaml](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/aws/cfn/frontend/template.yaml), [config.toml](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/aws/cfn/frontend/config.toml)

Create a new script [frontend](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/blob/main/bin/cfn/frontend) in ```bin/cfn``` dir
```
chmod u+x bin/cfn/frontend
./bin/cfn/frontend
```
![CrdFrontend success](https://github.com/Sksanth/aws-bootcamp-cruddur-2023-/assets/102387885/d4863d82-0d32-4f13-a585-7d572746981e)

## Cruddur Architecture diagram

